{% extends 'base.html' %}

{% block title %}Detalles de Ubicación{% endblock %}

{% block content %}
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <style>
        .mapa-wrapper {
            width: 100%;
            aspect-ratio: 2 / 1;
            border-radius: 14px;
            overflow: hidden;
            border: 1px solid rgba(200, 150, 60, 0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }
        #mapa {
            width: 100%;
            height: 100%;
        }
        /* Popup personalizado */
        .leaflet-popup-content-wrapper {
            background: rgba(20, 12, 4, 0.92);
            border: 1px solid rgba(200, 150, 60, 0.4);
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
        }
        .leaflet-popup-content {
            color: #f0e0b0;
            font-family: inherit;
            font-weight: 600;
            font-size: 0.9rem;
            margin: 10px 14px;
        }
        .leaflet-popup-tip {
            background: rgba(20, 12, 4, 0.92);
        }
        .leaflet-popup-close-button {
            color: rgba(200, 150, 60, 0.7) !important;
        }
        .page-title {
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            color: #fff;
        }
        .section-label {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: rgba(255,255,255,0.5);
            margin-bottom: 0.75rem;
        }
        /* Acordeón moderno */
        .accordion-item {
            background: rgba(255,255,255,0.07);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 12px !important;
            overflow: hidden;
        }
        .accordion-button {
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-weight: 600;
            border-radius: 12px !important;
        }
        .accordion-button:not(.collapsed) {
            background: rgba(255,255,255,0.1);
            color: #fff;
            box-shadow: none;
        }
        .accordion-button::after {
            filter: invert(1);
        }
        .accordion-body { background: transparent; }
        .form-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 1.5rem;
        }
        .form-label {
            color: rgba(255,255,255,0.85);
            font-size: 0.82rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .form-control {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            color: #fff;
            border-radius: 8px;
        }
        .form-control:focus {
            background: rgba(255,255,255,0.12);
            border-color: rgba(255,255,255,0.4);
            color: #fff;
            box-shadow: 0 0 0 3px rgba(255,255,255,0.08);
        }
        .form-control::placeholder { color: rgba(255,255,255,0.3); }
        /* Ficha de información */
        .info-card {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 14px;
            overflow: hidden;
        }
        .info-row {
            display: flex;
            align-items: baseline;
            padding: 13px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.07);
            font-size: 0.93rem;
        }
        .info-row:last-child { border-bottom: none; }
        .info-key {
            min-width: 160px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.07em;
            color: rgba(255,255,255,0.55);
            flex-shrink: 0;
        }
        .info-val {
            color: #e8eaf0;
            font-weight: 400;
        }
        .info-val.muted {
            color: rgba(255,255,255,0.35);
            font-style: italic;
        }
        .badge-cap {
            display: inline-block;
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.8);
            border-radius: 20px;
            padding: 3px 12px;
            font-size: 0.82rem;
            font-weight: 600;
        }
        /* Botones de acción coherentes */
        .btn-glass {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(255,255,255,0.07);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 20px;
            padding: 6px 16px;
            color: rgba(255,255,255,0.85);
            font-size: 0.82rem;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: background 0.15s, color 0.15s;
        }
        .btn-glass:hover { background: rgba(255,255,255,0.13); color: #fff; }
        .btn-glass-primary {
            background: rgba(200,150,60,0.2);
            border-color: rgba(200,150,60,0.4);
            color: #f0c878;
        }
        .btn-glass-primary:hover { background: rgba(200,150,60,0.35); color: #f0c878; }
        .btn-glass-danger {
            background: rgba(220,53,69,0.15);
            border-color: rgba(220,53,69,0.3);
            color: #f87171;
        }
        .btn-glass-danger:hover { background: rgba(220,53,69,0.3); color: #f87171; }
        /* Sección de notas */
        .notas-wrap {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 14px;
            overflow: hidden;
        }
        .nota-add-row {
            display: flex;
            gap: 10px;
            padding: 14px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.07);
        }
        .nota-item {
            border-bottom: 1px solid rgba(255,255,255,0.06);
            transition: background 0.15s;
        }
        .nota-item:last-child { border-bottom: none; }
        .nota-item:hover { background: rgba(255,255,255,0.04); }
        .nota-view {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            gap: 12px;
        }
        .nota-texto {
            color: #e8eaf0;
            font-size: 0.9rem;
            flex: 1;
        }
        .nota-acciones { display: flex; gap: 6px; flex-shrink: 0; }
        .nota-edit-row {
            display: none;
            padding: 10px 16px;
            gap: 8px;
        }
        .notas-empty {
            padding: 30px 16px;
            text-align: center;
            color: rgba(255,255,255,0.3);
            font-size: 0.88rem;
            font-style: italic;
        }
        .btn-volver {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.07);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 20px;
            padding: 7px 18px;
            color: rgba(255,255,255,0.8);
            font-size: 0.85rem;
            font-weight: 600;
            text-decoration: none;
            transition: background 0.15s, color 0.15s;
        }
        .btn-volver:hover {
            background: rgba(255,255,255,0.13);
            color: #fff;
        }
    </style>

    <h1 class="page-title mb-4">{{ ubicacion.nombre }}</h1>

    <!-- Acordeón para el formulario de edición -->
    <div class="accordion mb-4" id="formAccordion">
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingForm">
                <button class="accordion-button {{ '' if accordion_open else 'collapsed' }}" type="button" data-bs-toggle="collapse" data-bs-target="#collapseForm" aria-expanded="{{ 'true' if accordion_open else 'false' }}" aria-controls="collapseForm">
                    Editar Ubicación
                </button>
            </h2>
            <div id="collapseForm" class="accordion-collapse collapse {{ 'show' if accordion_open else '' }}" aria-labelledby="headingForm" data-bs-parent="#formAccordion">
                <div class="accordion-body">
                    <div class="form-card">
                        <form method="POST" action="{{ url_for('ubicacion_detalle', ubicacion_id=ubicacion._id) }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="ubicacion_id" value="{{ ubicacion._id }}">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="nombre" class="form-label">Nombre</label>
                                    <input type="text" class="form-control" id="nombre" name="nombre" value="{{ ubicacion.nombre }}" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="ubicacion" class="form-label">Dirección</label>
                                    <input type="text" class="form-control" id="ubicacion" name="ubicacion" value="{{ ubicacion.ubicacion }}" required>
                                </div>
                                <div class="col-md-4">
                                    <label for="capacidad" class="form-label">Capacidad</label>
                                    <input type="number" class="form-control" id="capacidad" name="capacidad" value="{{ ubicacion.capacidad }}" required min="0">
                                </div>
                                <div class="col-md-4">
                                    <label for="latitud" class="form-label">Latitud</label>
                                    <input type="number" class="form-control" id="latitud" name="latitud" value="{{ ubicacion.coordenadas.latitud if ubicacion.coordenadas else '' }}" step="any" min="-90" max="90" placeholder="Ej. 40.4168">
                                </div>
                                <div class="col-md-4">
                                    <label for="longitud" class="form-label">Longitud</label>
                                    <input type="number" class="form-control" id="longitud" name="longitud" value="{{ ubicacion.coordenadas.longitud if ubicacion.coordenadas else '' }}" step="any" min="-180" max="180" placeholder="Ej. -3.7038">
                                </div>
                                <div class="col-md-6">
                                    <label for="contacto" class="form-label">Contacto</label>
                                    <input type="text" class="form-control" id="contacto" name="contacto" value="{{ ubicacion.contacto }}">
                                </div>
                                <div class="col-md-6">
                                    <label for="servicios" class="form-label">Servicios</label>
                                    <textarea class="form-control" id="servicios" name="servicios" rows="1">{{ ubicacion.servicios }}</textarea>
                                </div>
                            </div>
                            <div class="mt-3 d-flex gap-2">
                                <button type="submit" class="btn-glass btn-glass-primary">Actualizar</button>
                                <a href="{{ url_for('ubicaciones') }}" class="btn-glass">Cancelar</a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ficha de información -->
    <p class="section-label">Información</p>
    <div class="info-card mb-4">
        <div class="info-row">
            <span class="info-key">Dirección</span>
            <span class="info-val">{{ ubicacion.ubicacion }}</span>
        </div>
        <div class="info-row">
            <span class="info-key">Capacidad</span>
            <span class="info-val"><span class="badge-cap">{{ ubicacion.capacidad }}</span></span>
        </div>
        <div class="info-row">
            <span class="info-key">Coordenadas</span>
            <span class="info-val {% if not ubicacion.coordenadas %}muted{% endif %}">
                {% if ubicacion.coordenadas %}
                    {{ ubicacion.coordenadas.latitud }}, {{ ubicacion.coordenadas.longitud }}
                {% else %}
                    No especificadas
                {% endif %}
            </span>
        </div>
        <div class="info-row">
            <span class="info-key">Servicios</span>
            <span class="info-val {% if not ubicacion.servicios %}muted{% endif %}">{{ ubicacion.servicios or 'Ninguno' }}</span>
        </div>
        <div class="info-row">
            <span class="info-key">Contacto</span>
            <span class="info-val {% if not ubicacion.contacto %}muted{% endif %}">{{ ubicacion.contacto or 'Ninguno' }}</span>
        </div>
    </div>

    <!-- Notas -->
    {% set notas_lista = ubicacion.notas.split('***') | select('ne', '') | list if ubicacion.notas else [] %}
    <p class="section-label mt-4">Notas</p>
    <div class="notas-wrap mb-4">
        <!-- Añadir nota -->
        <form method="POST" action="{{ url_for('nota_add', ubicacion_id=ubicacion._id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="nota-add-row">
                <input type="text" name="nota_texto" class="form-control" placeholder="Añadir nota..." required>
                <button type="submit" class="btn-glass btn-glass-primary" style="white-space:nowrap">+ Añadir</button>
            </div>
        </form>
        <!-- Lista de notas -->
        {% for nota in notas_lista %}
            {% set idx = loop.index0 %}
            {% set nota = nota.strip() %}
            {% if nota %}
            <div class="nota-item" id="nota-{{ idx }}">
                <div class="nota-view">
                    <span class="nota-texto">{{ nota }}</span>
                    <div class="nota-acciones">
                        <button class="btn-glass" onclick="editarNota({{ idx }})">Editar</button>
                        <form method="POST" action="{{ url_for('nota_delete', ubicacion_id=ubicacion._id, nota_idx=idx) }}" style="display:inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn-glass btn-glass-danger" onclick="return confirm('¿Eliminar esta nota?')">Eliminar</button>
                        </form>
                    </div>
                </div>
                <form method="POST" action="{{ url_for('nota_edit', ubicacion_id=ubicacion._id, nota_idx=idx) }}" class="nota-edit-row" id="edit-{{ idx }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="text" name="nota_texto" class="form-control" value="{{ nota }}" required>
                    <button type="submit" class="btn-glass btn-glass-primary" style="white-space:nowrap">Guardar</button>
                    <button type="button" class="btn-glass" onclick="cancelarEdit({{ idx }})" style="white-space:nowrap">Cancelar</button>
                </form>
            </div>
            {% endif %}
        {% else %}
            <div class="notas-empty">Sin notas registradas.</div>
        {% endfor %}
    </div>

    <!-- Mapa -->
    <p class="section-label">Mapa</p>
    <div class="mapa-wrapper mb-4">
        <div id="mapa"></div>
    </div>

    <a href="{{ url_for('ubicaciones') }}" class="btn-volver">← Volver a Ubicaciones</a>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var mapa = L.map('mapa', { zoomControl: true }).setView(
                [{% if ubicacion.coordenadas %}{{ ubicacion.coordenadas.latitud }}, {{ ubicacion.coordenadas.longitud }}{% else %}0, 0{% endif %}], 14
            );

            // Tiles CartoDB Voyager (tonos cálidos tierra)
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> © <a href="https://carto.com/">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(mapa);

            {% if ubicacion.coordenadas %}
                // Marcador personalizado ámbar
                var icono = L.divIcon({
                    className: '',
                    html: '<div style="width:16px;height:16px;background:#c8963c;border:3px solid #f0c878;border-radius:50%;box-shadow:0 0 0 4px rgba(200,150,60,0.25), 0 2px 8px rgba(0,0,0,0.6);"></div>',
                    iconSize: [16, 16],
                    iconAnchor: [8, 8],
                    popupAnchor: [0, -14]
                });

                L.marker(
                    [{{ ubicacion.coordenadas.latitud }}, {{ ubicacion.coordenadas.longitud }}],
                    { icon: icono }
                ).addTo(mapa)
                    .bindPopup({{ ubicacion.nombre | tojson }})
                    .openPopup();
            {% endif %}
        });
    </script>

    <script>
        function editarNota(idx) {
            document.querySelector('#nota-' + idx + ' .nota-view').style.display = 'none';
            const editRow = document.getElementById('edit-' + idx);
            editRow.style.display = 'flex';
            editRow.querySelector('input[name="nota_texto"]').focus();
        }
        function cancelarEdit(idx) {
            document.querySelector('#nota-' + idx + ' .nota-view').style.display = 'flex';
            document.getElementById('edit-' + idx).style.display = 'none';
        }
    </script>
{% endblock %}
